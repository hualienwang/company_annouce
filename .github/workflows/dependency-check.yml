name: Dependency Check

on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨ 3 ç‚¹è¿è¡Œ
    - cron: '0 3 * * 1'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # ========================================
  # ä½œä¸š 1: Python ä¾èµ–æ£€æŸ¥
  # ========================================
  python-dependencies:
    name: Python Dependency Check
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: å®‰è£…ä¾èµ–æ£€æŸ¥å·¥å…·
      run: |
        pip install safety pip-audit

    - name: è¿è¡Œ Safety å®‰å…¨æ£€æŸ¥
      run: |
        cd backend
        safety check --json > safety-report.json || true
        safety check || true

    - name: è¿è¡Œ Pip Audit æ£€æŸ¥
      run: |
        cd backend
        pip-audit --format=json --output=pip-audit-report.json || true
        pip-audit || true

    - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: python-dependency-reports
        path: |
          backend/safety-report.json
          backend/pip-audit-report.json
        retention-days: 30

    - name: åˆ›å»º Issueï¼ˆå¦‚æœå‘ç°æ¼æ´ï¼‰
      if: failure()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.issues.create({
            title: 'ğŸš¨ Python ä¾èµ–å®‰å…¨æ¼æ´æ£€æµ‹',
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'æ£€æµ‹åˆ° Python ä¾èµ–å­˜åœ¨å®‰å…¨æ¼æ´ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šå¹¶å°½å¿«æ›´æ–°ä¾èµ–ã€‚\n\næŠ¥å‘Šæ–‡ä»¶å·²ä¸Šä¼ åˆ° Artifactsã€‚',
            labels: ['security', 'dependencies']
          })

  # ========================================
  # ä½œä¸š 2: Node.js ä¾èµ–æ£€æŸ¥
  # ========================================
  nodejs-dependencies:
    name: Node.js Dependency Check
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js ç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: å®‰è£…ä¾èµ–
      run: |
        cd frontend
        npm ci

    - name: è¿è¡Œ npm audit
      run: |
        cd frontend
        npm audit --json > npm-audit-report.json || true
        npm audit || true

    - name: æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
      run: |
        cd frontend
        npm outdated --json > npm-outdated-report.json || true

    - name: ä¸Šä¼ ä¾èµ–æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: nodejs-dependency-reports
        path: |
          frontend/npm-audit-report.json
          frontend/npm-outdated-report.json
        retention-days: 30

    - name: åˆ›å»º Issueï¼ˆå¦‚æœå‘ç°æ¼æ´ï¼‰
      if: failure()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.issues.create({
            title: 'ğŸš¨ Node.js ä¾èµ–å®‰å…¨æ¼æ´æ£€æµ‹',
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'æ£€æµ‹åˆ° Node.js ä¾èµ–å­˜åœ¨å®‰å…¨æ¼æ´ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šå¹¶å°½å¿«æ›´æ–°ä¾èµ–ã€‚\n\næŠ¥å‘Šæ–‡ä»¶å·²ä¸Šä¼ åˆ° Artifactsã€‚',
            labels: ['security', 'dependencies']
          })

  # ========================================
  # ä½œä¸š 3: ç”Ÿæˆä¾èµ–æ›´æ–°å»ºè®®
  # ========================================
  dependency-update-suggestions:
    name: Dependency Update Suggestions
    runs-on: ubuntu-latest
    needs: [python-dependencies, nodejs-dependencies]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ç”Ÿæˆä¾èµ–æ›´æ–°æŠ¥å‘Š
      run: |
        cat > DEPENDENCY_UPDATE_REPORT.md << 'EOF'
        # ä¾èµ–æ›´æ–°å»ºè®®æŠ¥å‘Š

        ğŸ“… ç”Ÿæˆæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

        ## æ£€æŸ¥ç»“æœæ‘˜è¦

        - âœ… Python ä¾èµ–æ£€æŸ¥: å®Œæˆ
        - âœ… Node.js ä¾èµ–æ£€æŸ¥: å®Œæˆ

        ## å»ºè®®æ“ä½œ

        1. **æŸ¥çœ‹å®‰å…¨æŠ¥å‘Š**: è¯·ä¸‹è½½ Artifacts ä¸­çš„è¯¦ç»†æŠ¥å‘Š
        2. **æ›´æ–°ä¾èµ–**: ä½¿ç”¨ `pip install -U <package>` æˆ– `npm update <package>`
        3. **æµ‹è¯•éªŒè¯**: æ›´æ–°åè¯·è¿è¡Œå®Œæ•´çš„æµ‹è¯•å¥—ä»¶

        ## è‡ªåŠ¨æ›´æ–°å·¥å…·æ¨è

        - Python: `pip install --upgrade pip-tools`
        - Node.js: `npm install -g npm-check-updates`

        ---
        *æ­¤æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*
        EOF

    - name: ä¸Šä¼ æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: dependency-update-report
        path: DEPENDENCY_UPDATE_REPORT.md
        retention-days: 30
