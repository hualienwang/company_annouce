# 邮件发送配置快速指南

## 当前状态：模拟模式

系统当前使用**模拟模式**发送邮件，邮件内容只在控制台输出，不会真正发送。

### 为什么是模拟模式？

1. **开发环境便利**：无需配置真实的 SMTP 服务器即可测试功能
2. **防止配置错误**：避免因 SMTP 配置错误导致系统异常
3. **快速验证**：通过控制台查看邮件内容，验证业务逻辑

---

## 启用真实邮件发送

### 快速配置（3 步）

#### 第 1 步：准备 SMTP 配置

以 Gmail 为例：

```
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=your_email@gmail.com
SMTP_PASSWORD=your_app_password  # 应用专用密码
SMTP_FROM_EMAIL=your_email@gmail.com
```

#### 第 2 步：设置环境变量

**方式 A：使用 .env 文件**
```bash
# 复制示例文件
cp .env.example .env

# 编辑 .env 文件，填入真实配置
nano .env  # 或使用其他编辑器
```

**方式 B：直接设置环境变量**
```bash
export SMTP_USERNAME="your_email@gmail.com"
export SMTP_PASSWORD="your_app_password"
export SMTP_SERVER="smtp.gmail.com"
export SMTP_PORT="587"
```

#### 第 3 步：重启后端服务

```bash
# 如果使用 PM2
pm2 restart backend

# 或手动重启
# 停止当前后端进程
# 重新启动: python -m uvicorn backend.main:app --reload --port 5001
```

### 测试配置

运行测试脚本：
```bash
python scripts/test_smtp.py
```

如果看到 `✅ SMTP 配置测试通过！`，说明配置成功。

---

## 常用 SMTP 配置

### Gmail

1. 访问 https://myaccount.google.com/security
2. 启用"两步验证"
3. 生成应用专用密码
4. 使用应用专用密码配置

```
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=your_email@gmail.com
SMTP_PASSWORD=your_app_password
```

### 163 邮箱

1. 登录 163 邮箱 → 设置 → POP3/SMTP/IMAP
2. 开启 POP3/SMTP 服务
3. 使用邮箱密码或授权码

```
SMTP_SERVER=smtp.163.com
SMTP_PORT=465
SMTP_USERNAME=your_email@163.com
SMTP_PASSWORD=your_password
```

### QQ 邮箱

1. 登录 QQ 邮箱 → 设置 → 账户
2. 开启 POP3/IMAP/SMTP 服务
3. 生成授权码

```
SMTP_SERVER=smtp.qq.com
SMTP_PORT=587
SMTP_USERNAME=your_email@qq.com
SMTP_PASSWORD=your_auth_code
```

---

## 使用邮件功能

### 在管理后台发送邮件

1. 登录系统（管理员账号）
2. 访问管理后台（/admin）
3. 点击员工的"📧 Email"按钮
4. 填写邮件主题和内容
5. 点击"发送邮件"

### API 调用示例

```bash
curl -X POST http://localhost:5001/api/auth/send-email \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "to_email": "recipient@example.com",
    "subject": "测试邮件",
    "body": "这是一封测试邮件"
  }'
```

---

## 模拟模式 vs 真实模式

| 特性 | 模拟模式 | 真实模式 |
|-----|---------|---------|
| 配置难度 | 无需配置 | 需要 SMTP 配置 |
| 邮件发送 | 控制台输出 | 真实发送 |
| 适合场景 | 开发测试 | 生产环境 |
| 错误处理 | 无真实错误 | 可能遇到 SMTP 错误 |

---

## 故障排除

### 问题：邮件发送失败

**检查清单：**
1. ✅ 环境变量是否正确设置？
2. ✅ SMTP 用户名和密码是否正确？
3. ✅ 网络是否能访问 SMTP 服务器？
4. ✅ 防火墙是否允许 SMTP 连接？

**解决方法：**
```bash
# 运行测试脚本
python scripts/test_smtp.py

# 查看详细错误日志
# 检查后端控制台输出
```

### 问题：Gmail 认证失败

**错误信息：** `AuthenticationError`

**解决方法：**
1. 确保已开启两步验证
2. 使用应用专用密码（https://myaccount.google.com/apppasswords）
3. 不要使用 Gmail 账户密码

---

## 详细文档

如需更详细的配置说明，请查看：
- `docs/邮件发送配置说明.md` - 完整配置文档
- `.env.example` - 配置文件示例
- `scripts/test_smtp.py` - 测试脚本

---

## 安全提醒

⚠️ **重要提示：**

1. **不要提交密码到版本控制**：`.env` 文件已在 `.gitignore` 中
2. **使用应用专用密码**：不要使用个人账户密码
3. **生产环境配置**：使用环境变量或配置管理服务
4. **日志安全**：不要在日志中记录完整的 SMTP 密码

---

## 联系支持

如果遇到问题，请：

1. 检查 `docs/邮件发送配置说明.md`
2. 运行 `python scripts/test_smtp.py` 进行诊断
3. 查看后端控制台错误日志
4. 联系系统管理员
