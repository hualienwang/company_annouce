# better-sqlite3 Native 模块编译说明

## 问题描述
在使用 `better-sqlite3` 时出现以下错误：
```
Runtime Error
Could not locate bindings file. Tried:
→ /workspace/projects/node_modules/.pnpm/better-sqlite3@12.5.0/node_modules/better-sqlite3/build/better_sqlite3.node
...
```

## 解决方法

### 方法一：使用 npm rebuild（推荐）
```bash
npm rebuild better-sqlite3
```

### 方法二：使用 pnpm rebuild
```bash
pnpm rebuild better-sqlite3
```

### 方法三：手动编译
```bash
cd node_modules/better-sqlite3
npm run build-release
```

## 原因说明

`better-sqlite3` 是一个 native 模块，需要针对当前 Node.js 版本和操作系统编译二进制文件。当出现以下情况时需要重新编译：

1. **更换 Node.js 版本**：不同版本的 Node.js ABI 不兼容
2. **更换操作系统**：Linux、macOS、Windows 的二进制文件不同
3. **更换 CPU 架构**：x64、ARM64 需要不同的编译
4. **依赖安装问题**：某些情况下 pnpm 没有自动编译 native 模块

## 验证编译结果

编译完成后，应该能看到 `better_sqlite3.node` 文件：

```bash
find node_modules -name "better_sqlite3.node"
# 输出示例：
# node_modules/.pnpm/better-sqlite3@12.5.0/node_modules/better-sqlite3/build/Release/better_sqlite3.node
```

## 自动化方案

为了避免每次都要手动编译，可以在 package.json 中添加脚本：

```json
{
  "scripts": {
    "postinstall": "npm rebuild better-sqlite3"
  }
}
```

这样每次运行 `pnpm install` 后都会自动重新编译。

## 当前系统状态

- ✅ Node.js 版本：v24
- ✅ better-sqlite3 版本：12.5.0
- ✅ Native 模块已编译
- ✅ 数据库连接正常
- ✅ 所有功能正常工作

## 故障排查

如果编译后仍然报错，可以尝试：

1. **清理缓存**
   ```bash
   rm -rf node_modules/.cache
   rm -rf .next
   ```

2. **完全重新安装**
   ```bash
   rm -rf node_modules
   pnpm install
   npm rebuild better-sqlite3
   ```

3. **检查构建工具**
   确保 Python 和构建工具已安装：
   ```bash
   python3 --version
   make --version
   gcc --version
   ```
